@model SkillBridge.Models.PublicProfileViewModel
@using Microsoft.AspNet.Identity

@section Styles {
    <link rel="stylesheet" href="~/Styles/publicProfile.css" />
}

<div class="profile-header">
    <img src="@Model.ProfileImageUrl" alt="@Model.FullName" class="rounded-circle" width="120" height="120" />
    <h2>@Model.FullName’s Profile</h2>
</div>

<p>@Model.Profession | @Model.Location</p>
<p>@Model.Bio</p>

<h4>Average Rating</h4>
<p>
    @Model.AverageRating.ToString("0.0") / 10
    (out of @Model.RatingsReceived rated interaction@(Model.RatingsReceived == 1 ? "" : "s"))
</p>
<p>
    Completed total @Model.InteractionsCompleted interaction@(Model.InteractionsCompleted == 1 ? "" : "s")
</p>


<h3>Skills @Model.FullName knows</h3>
<ul id="skillsToTeachList">
    @foreach (var skill in Model.SkillsToTeach)
    {
        var showButton = skill.RequestStatus != "Hidden";
        var buttonText = "Request";
        var isDisabled = false;

        if (skill.RequestStatus == "Pending") { buttonText = "Request Sent"; isDisabled = true; }
        else if (skill.RequestStatus == "Declined") { buttonText = "Request Again"; }

        <li>
            @skill.SkillName (Stage: @skill.Stage)
            @if (showButton)
            {
                <button class="btn btn-primary requestSkillBtn"
                        data-userskill-id="@skill.UserSkillId"
                        data-profile-id="@Model.UserId"
                        @((isDisabled) ? "disabled=\"disabled\"" : "")>
                    @buttonText
                </button>
            }
        </li>
    }
</ul>

<h3>Skills @Model.FullName wants to learn</h3>
<ul>
    @foreach (var skill in Model.SkillsToLearn)
    {
        <li>@skill.SkillName (Stage: @skill.Stage)</li>
    }
</ul>

@section Scripts {
    <script src="~/bundles/jquery"></script>
    <script>
        $(document).ready(function () {
            $(".requestSkillBtn").click(function () {
                var $btn = $(this);
                var userSkillId = $btn.data("userskill-id");
                var profileId = $btn.data("profile-id");

                if (!confirm("Send a request to learn " + $btn.closest("li").text() + "?")) return;

                $.ajax({
                    url: '@Url.Action("SendSkillRequest", "Profile")',
                    type: 'POST',
                    data: { userSkillId: userSkillId, profileId: profileId },
                    success: function (res) {
                        if (res.success) {
                            $btn.text("Request Sent");
                            $btn.prop("disabled", true);
                            alert("Request sent successfully!");
                        } else {
                            alert(res.message || "Failed to send request.");
                        }
                    },
                    error: function () {
                        alert("Error sending request. Try again.");
                    }
                });
            });
        });
    </script>
}
