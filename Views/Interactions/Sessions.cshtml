@model SkillBridge.Models.InteractionSessionsViewModel


@section Styles {
    <link rel="stylesheet" href="~/Styles/sessions.css" />
}


<div class="skill-blocks">
    @foreach (var stage in Model.SkillBlocks)
    {
        <div class="stage @stage.Status"
             data-stage="@stage.StageNumber"
             data-skill="@stage.SkillId">
            <span>@stage.StageNumber: @stage.Description</span>
            @if (!stage.IsLocked && !stage.UserConfirmed)
            {
                <button class="mark-done" data-stage="@stage.StageNumber" data-skill="@stage.SkillId">
                    Mark Done
                </button>
            }
        </div>
    }
</div>

<!-- End Interaction Button -->
@if (Model.SkillBlocks.All(s => s.Status == "Green"))
{
    <button id="end-interaction-btn" class="btn btn-success">End Interaction</button>
}

@section scripts {
    <script>
        $(document).ready(function () {

            $(".mark-done").click(function () {
                var button = $(this);
                var stageNumber = button.data("stage");
                var skillId = button.data("skill");

                $.post("@Url.Action("MarkStageDone", "Interactions")",
                    { stageNumber: stageNumber, skillId: skillId, interactionId: @Model.InteractionId },
                    function (response) {
                        if (response.success) {
                            var stageDiv = button.closest(".stage");
                            if (response.status === "Confirmed") {
                                stageDiv.removeClass("Red Yellow").addClass("Green");
                            } else {
                                stageDiv.removeClass("Red Green").addClass("Yellow");
                            }
                            button.remove();

                            if ($(".stage").length === $(".stage.Green").length && $("#end-interaction-btn").length === 0) {
                                $(".skill-blocks").after('<button id="end-interaction-btn" class="btn btn-success">End Interaction</button>');
                                attachEndInteractionClick();
                            }
                        }
                    });
            });

            function attachEndInteractionClick() {
                $("#end-interaction-btn").click(function () {
                    $.post("@Url.Action("EndInteraction", "Interactions")",
                        { id: @Model.InteractionId },
                        function (response) {
                            alert("Interaction completed!");
                            window.location.href = "@Url.Action("Index", "Interactions")";
                        });
                });
            }

            attachEndInteractionClick();
        });
    </script>
}
